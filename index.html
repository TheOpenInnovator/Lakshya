<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pragyaan 2.0 - UPSC Quiz Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a202c 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 1rem;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-card);
            padding: 0.5rem;
            border-radius: 12px;
            overflow-x: auto;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .card h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        /* Form Elements */
        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea.input-field {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Quiz Layout */
        .quiz-layout {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 1024px) {
            .quiz-layout {
                grid-template-columns: 280px 1fr;
            }
        }

        /* Question Navigator */
        .question-navigator {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            position: sticky;
            top: 1rem;
            height: fit-content;
        }

        .navigator-header {
            margin-bottom: 1rem;
        }

        .timer {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer.critical {
            color: var(--error);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .nav-btn {
            aspect-ratio: 1;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .nav-btn.current {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .nav-btn.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .nav-btn.marked {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .nav-btn.incorrect {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .legend {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Question Area */
        .question-area {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .question-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .question-counter {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .question-content {
            padding: 2rem;
            flex: 1;
            overflow-y: auto;
        }

        .question-stem {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            color: var(--text-primary);
            white-space: pre-line;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.25rem;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .option.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .option input[type="radio"] {
            margin-top: 0.2rem;
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .option label {
            flex: 1;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1.6;
        }

        .question-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Question Review */
        .question-review {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-left: 4px solid var(--border);
        }

        .question-review.correct {
            border-left-color: var(--success);
        }

        .question-review.incorrect {
            border-left-color: var(--error);
        }

        .question-review.skipped {
            border-left-color: var(--warning);
        }

        .question-review h4 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .rationale {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 3px solid var(--primary);
            font-size: 0.95rem;
            line-height: 1.7;
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        /* Schema Template */
        .schema-template {
            background: var(--bg-dark);
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre;
            border: 1px solid var(--border);
            line-height: 1.5;
        }

        /* Mains Question */
        .mains-container {
            background: var(--bg-dark);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .word-count {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .card {
                padding: 1.5rem;
            }

            .question-content {
                padding: 1.5rem;
            }

            .tabs {
                padding: 0.25rem;
            }

            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            .nav-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .btn {
                font-size: 0.85rem;
                padding: 0.65rem 1.25rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-hover);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üèõÔ∏è Lakshya </h1>
            <p>Advanced UPSC Quiz Platform for Prelims & Mains Preparation</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="upload">üì§ Upload Dataset</button>
            <button class="tab" data-tab="quiz">üìù Practice Quiz</button>
            <button class="tab" data-tab="results">üìä Results & Analytics</button>
            <button class="tab" data-tab="schema">üìã Schema Guide</button>
        </div>

        <!-- Upload Tab -->
        <div class="tab-content active" id="upload">
            <div class="card">
                <h3>Import Quiz Dataset</h3>
                <div class="input-group">
                    <label>Upload JSON File</label>
                    <input type="file" class="input-field" id="fileInput" accept=".json">
                </div>
                <div class="input-group">
                    <label>Or Paste JSON Data</label>
                    <textarea class="input-field" id="jsonInput" placeholder="Paste your JSON dataset here..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="validateData">üîç Validate & Load Data</button>
                    <button class="btn btn-secondary" id="clearData">üóëÔ∏è Clear All Data</button>
                </div>
                <div id="validationMessage"></div>
            </div>

            <div class="card">
                <h3>Quick Start Guide</h3>
                <div class="alert alert-info">
                    <span>üí°</span>
                    <div>
                        <strong>Getting Started:</strong><br>
                        1. Upload a JSON file or paste JSON data above<br>
                        2. Click "Validate & Load Data" to check the format<br>
                        3. Navigate to "Practice Quiz" tab to start<br>
                        4. View detailed results in "Results & Analytics" after submission
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Tab -->
        <div class="tab-content" id="quiz">
            <div id="quizNotLoaded" class="card">
                <h3>‚ö†Ô∏è No Quiz Loaded</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Please upload a valid JSON dataset first to start practicing.
                </p>
                <button class="btn btn-primary" onclick="document.querySelector('[data-tab=upload]').click()">
                    Go to Upload Section
                </button>
            </div>
            
            <div id="quizInterface" class="hidden">
                <div class="card">
                    <h3>Quiz Controls</h3>
                    <div class="btn-group">
                        <button class="btn btn-success" id="startQuiz">üöÄ Start Quiz</button>
                        <button class="btn btn-danger hidden" id="submitQuiz">üì§ Submit Quiz</button>
                    </div>
                    <div id="quizInfo" class="alert alert-info hidden" style="margin-top: 1rem;">
                        <span>‚ÑπÔ∏è</span>
                        <div id="quizInfoText"></div>
                    </div>
                </div>

                <div id="quizStarted" class="hidden">
                    <div class="quiz-layout">
                        <!-- Navigator -->
                        <div class="question-navigator">
                            <div class="navigator-header">
                                <div class="timer" id="timer">‚è∞ 00:00:00</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Question Navigator</div>
                            </div>
                            <div class="nav-grid" id="navGrid"></div>
                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-dot" style="background: var(--success);"></div>
                                    <span>Answered</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot" style="background: var(--warning);"></div>
                                    <span>Marked for Review</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot" style="background: var(--bg-dark); border: 2px solid var(--border);"></div>
                                    <span>Not Attempted</span>
                                </div>
                            </div>
                        </div>

                        <!-- Question Area -->
                        <div class="question-area">
                            <div class="question-header">
                                <div class="question-counter" id="questionCounter">Question 1 of 10</div>
                                <div class="timer" id="timerDisplay">‚è∞ 00:00:00</div>
                            </div>
                            
                            <div class="question-content">
                                <div class="question-stem" id="questionStem"></div>
                                <div class="options" id="optionsContainer"></div>
                            </div>
                            
                            <div class="question-footer">
                                <div class="btn-group">
                                    <button class="btn btn-secondary" id="prevQuestion">‚Üê Previous</button>
                                    <button class="btn btn-secondary" id="nextQuestion">Next ‚Üí</button>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-warning" id="markReview">‚≠ê Mark for Review</button>
                                    <button class="btn btn-secondary" id="clearResponse">üóëÔ∏è Clear Response</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-content" id="results">
            <div id="resultsNotAvailable" class="card">
                <h3>üìä No Results Available</h3>
                <p style="color: var(--text-secondary);">
                    Complete a quiz to view detailed results and analytics.
                </p>
            </div>

            <div id="resultsInterface" class="hidden">
                <div class="card">
                    <h3>Quiz Performance Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="finalScore" style="color: var(--primary);">0</div>
                            <div class="stat-label">Final Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="questionsAttempted" style="color: var(--secondary);">0</div>
                            <div class="stat-label">Questions Attempted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="correctAnswers" style="color: var(--success);">0</div>
                            <div class="stat-label">Correct Answers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="incorrectAnswers" style="color: var(--error);">0</div>
                            <div class="stat-label">Incorrect Answers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="accuracy" style="color: var(--warning);">0%</div>
                            <div class="stat-label">Accuracy Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="timeTaken" style="color: var(--text-secondary);">0m</div>
                            <div class="stat-label">Time Taken</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="exportResults">üíæ Export Results (JSON)</button>
                        <button class="btn btn-success" id="downloadSummary">üìÑ Download PDF Report</button>
                        <button class="btn btn-secondary" id="retakeQuiz">üîÑ Retake Quiz</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Detailed Question Review</h3>
                    <div id="questionReviews"></div>
                </div>
            </div>
        </div>

        <!-- Schema Tab -->
        <div class="tab-content" id="schema">
            <div class="card">
                <h3>JSON Schema Template</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Use this template to create your quiz datasets. The platform supports both Prelims (MCQ) and Mains (descriptive) questions.
                </p>
                <div class="schema-template" id="schemaTemplate"></div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-primary" id="downloadSchema">üíæ Download Template</button>
                    <button class="btn btn-secondary" id="copySchema">üìã Copy to Clipboard</button>
                </div>
            </div>

            <div class="card">
                <h3>Schema Field Descriptions</h3>
                <div style="color: var(--text-secondary); line-height: 1.8;">
                    <p><strong>quiz:</strong> Contains quiz metadata and configuration</p>
                    <p><strong>title:</strong> Name of the quiz</p>
                    <p><strong>description:</strong> Brief description of the quiz</p>
                    <p><strong>marks_per_question:</strong> Points awarded per correct answer</p>
                    <p><strong>negative_marking:</strong> Penalty for incorrect answers</p>
                    <p><strong>time_limit_minutes:</strong> Total time allowed for the quiz</p>
                    <p><strong>questions:</strong> Array of question objects</p>
                    <p><strong>exam_type:</strong> Either "prelims" (MCQ) or "mains" (descriptive)</p>
                    <p><strong>stem:</strong> The question text</p>
                    <p><strong>options:</strong> Array of answer choices (for MCQ)</p>
                    <p><strong>answer:</strong> Correct answer option ID</p>
                    <p><strong>rationale:</strong> Detailed explanation of the answer</p>
                    <p><strong>difficulty:</strong> Easy, Moderate, or Hard</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class UPSCQuizPlatform {
            constructor() {
                this.currentDataset = null;
                this.currentQuestionIndex = 0;
                this.userAnswers = {};
                this.markedQuestions = new Set();
                this.quizStartTime = null;
                this.timer = null;
                this.quizResults = null;
                this.isQuizActive = false;
                this.elapsedTime = 0;
                
                this.initializeEventListeners();
                this.loadFromStorage();
                this.renderSchemaTemplate();
            }

            initializeEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });

                // File upload
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                
                // Data validation
                document.getElementById('validateData').addEventListener('click', () => this.validateAndLoadData());
                document.getElementById('clearData').addEventListener('click', () => this.clearAllData());

                // Quiz controls
                document.getElementById('startQuiz').addEventListener('click', () => this.startQuiz());
                document.getElementById('submitQuiz').addEventListener('click', () => this.submitQuiz());

                // Question navigation
                document.getElementById('prevQuestion').addEventListener('click', () => this.navigateQuestion(-1));
                document.getElementById('nextQuestion').addEventListener('click', () => this.navigateQuestion(1));
                document.getElementById('markReview').addEventListener('click', () => this.toggleMarkReview());
                document.getElementById('clearResponse').addEventListener('click', () => this.clearResponse());

                // Results actions
                document.getElementById('exportResults').addEventListener('click', () => this.exportResults());
                document.getElementById('downloadSummary').addEventListener('click', () => this.downloadSummaryPDF());
                document.getElementById('retakeQuiz').addEventListener('click', () => this.retakeQuiz());

                // Schema actions
                document.getElementById('downloadSchema').addEventListener('click', () => this.downloadSchemaTemplate());
                document.getElementById('copySchema').addEventListener('click', () => this.copySchemaToClipboard());

                // Auto-save every 30 seconds
                setInterval(() => {
                    if (this.isQuizActive && this.currentDataset) {
                        this.saveToStorage();
                    }
                }, 30000);

                // Keyboard navigation
                document.addEventListener('keydown', (e) => this.handleKeyboardNavigation(e));
            }

            handleKeyboardNavigation(e) {
                if (!this.isQuizActive) return;
                
                if (e.key === 'ArrowLeft' && this.currentQuestionIndex > 0) {
                    this.navigateQuestion(-1);
                } else if (e.key === 'ArrowRight' && this.currentQuestionIndex < this.currentDataset.questions.length - 1) {
                    this.navigateQuestion(1);
                } else if (e.key === 'm' || e.key === 'M') {
                    this.toggleMarkReview();
                }
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                const tab = document.querySelector(`[data-tab="${tabName}"]`);
                const content = document.getElementById(tabName);
                
                if (tab && content) {
                    tab.classList.add('active');
                    content.classList.add('active');
                }
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    document.getElementById('jsonInput').value = text;
                    this.showMessage(`File "${file.name}" loaded successfully. Click "Validate & Load Data" to proceed.`, 'success');
                } catch (error) {
                    this.showMessage('Error reading file: ' + error.message, 'error');
                }
            }

            validateAndLoadData() {
                const jsonText = document.getElementById('jsonInput').value.trim();
                
                if (!jsonText) {
                    this.showMessage('Please provide JSON data first.', 'error');
                    return;
                }

                try {
                    const data = JSON.parse(jsonText);
                    
                    if (this.validateSchema(data)) {
                        this.currentDataset = this.preprocessDataset(data);
                        this.saveToStorage();
                        this.initializeQuiz();
                        this.showMessage(
                            `‚úÖ Dataset loaded successfully! ${this.currentDataset.questions.length} questions found.`,
                            'success'
                        );
                        setTimeout(() => this.switchTab('quiz'), 1500);
                    }
                } catch (error) {
                    this.showMessage('Invalid JSON format: ' + error.message, 'error');
                }
            }

            preprocessDataset(data) {
                // Ensure all required fields have defaults
                data.questions = data.questions.map((q, index) => ({
                    id: q.id || `Q${String(index + 1).padStart(3, '0')}`,
                    question_type: q.question_type || 'MCQ',
                    exam_type: q.exam_type || 'prelims',
                    stem: q.stem || '',
                    options: q.options || [],
                    answer: q.answer || '',
                    rationale: q.rationale || 'No explanation provided.',
                    difficulty: q.difficulty || 'Moderate',
                    estimated_time: q.estimated_time || 90,
                    tags: q.tags || [],
                    ...q
                }));

                // Ensure quiz config
                if (!data.quiz.config) {
                    data.quiz.config = {};
                }
                
                data.quiz.config = {
                    marks_per_question: data.quiz.config.marks_per_question || 2,
                    negative_marking: data.quiz.config.negative_marking || { type: 'fraction', value: 0.33 },
                    time_limit_minutes: data.quiz.config.time_limit_minutes || 120,
                    ...data.quiz.config
                };

                return data;
            }

            validateSchema(data) {
                // Check required top-level fields
                if (!data.quiz || !data.questions) {
                    this.showMessage('Missing required fields: "quiz" and/or "questions"', 'error');
                    return false;
                }

                // Check questions array
                if (!Array.isArray(data.questions) || data.questions.length === 0) {
                    this.showMessage('Questions array is empty or invalid.', 'error');
                    return false;
                }

                // Validate each question
                for (let i = 0; i < data.questions.length; i++) {
                    const q = data.questions[i];
                    
                    if (!q.stem || q.stem.trim() === '') {
                        this.showMessage(`Question ${i + 1}: Missing question text (stem).`, 'error');
                        return false;
                    }

                    if (q.exam_type === 'prelims' || !q.exam_type) {
                        if (!q.options || !Array.isArray(q.options) || q.options.length === 0) {
                            this.showMessage(`Question ${i + 1}: MCQ questions must have options.`, 'error');
                            return false;
                        }
                        if (!q.answer) {
                            this.showMessage(`Question ${i + 1}: Missing correct answer.`, 'error');
                            return false;
                        }
                    }
                }

                return true;
            }

            initializeQuiz() {
                document.getElementById('quizNotLoaded').classList.add('hidden');
                document.getElementById('quizInterface').classList.remove('hidden');
                
                const info = document.getElementById('quizInfo');
                const infoText = document.getElementById('quizInfoText');
                
                info.classList.remove('hidden');
                infoText.innerHTML = `
                    <strong>${this.currentDataset.quiz.title || 'Quiz Ready'}</strong><br>
                    ${this.currentDataset.questions.length} questions | 
                    ${this.currentDataset.quiz.config.time_limit_minutes} minutes | 
                    ${this.currentDataset.quiz.config.marks_per_question} marks per question
                `;
                
                this.generateNavigationGrid();
            }

            generateNavigationGrid() {
                const navGrid = document.getElementById('navGrid');
                navGrid.innerHTML = '';
                
                this.currentDataset.questions.forEach((question, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'nav-btn';
                    btn.textContent = index + 1;
                    btn.setAttribute('aria-label', `Question ${index + 1}`);
                    btn.addEventListener('click', () => this.jumpToQuestion(index));
                    navGrid.appendChild(btn);
                });
            }

            startQuiz() {
                if (!this.currentDataset) {
                    this.showMessage('No quiz loaded.', 'error');
                    return;
                }

                // Reset quiz state
                this.isQuizActive = true;
                this.quizStartTime = Date.now();
                this.elapsedTime = 0;
                this.userAnswers = {};
                this.markedQuestions = new Set();
                this.currentQuestionIndex = 0;
                
                // Update UI
                document.getElementById('startQuiz').classList.add('hidden');
                document.getElementById('submitQuiz').classList.remove('hidden');
                document.getElementById('quizStarted').classList.remove('hidden');
                document.getElementById('quizInfo').classList.add('hidden');
                
                this.startTimer();
                this.displayQuestion(0);
                this.showMessage('Quiz started! Good luck! üéØ', 'success');
            }

            startTimer() {
                const timeLimit = this.currentDataset.quiz.config.time_limit_minutes * 60;
                
                this.timer = setInterval(() => {
                    this.elapsedTime++;
                    const remaining = timeLimit - this.elapsedTime;
                    
                    if (remaining <= 0) {
                        this.submitQuiz(true);
                        return;
                    }
                    
                    this.updateTimerDisplay(remaining);
                    
                    // Warning at 5 minutes
                    if (remaining === 300) {
                        this.showMessage('‚ö†Ô∏è Only 5 minutes remaining!', 'warning');
                    }
                }, 1000);
            }

            updateTimerDisplay(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                
                const timerElements = [
                    document.getElementById('timer'),
                    document.getElementById('timerDisplay')
                ];
                
                timerElements.forEach(el => {
                    if (el) {
                        el.innerHTML = `‚è∞ ${timeString}`;
                        if (seconds <= 300) {
                            el.classList.add('critical');
                        } else {
                            el.classList.remove('critical');
                        }
                    }
                });
            }

            displayQuestion(index) {
                if (index < 0 || index >= this.currentDataset.questions.length) return;
                
                this.currentQuestionIndex = index;
                const question = this.currentDataset.questions[index];
                
                // Update counter
                document.getElementById('questionCounter').textContent = 
                    `Question ${index + 1} of ${this.currentDataset.questions.length}`;
                
                // Update progress
                const progress = ((index + 1) / this.currentDataset.questions.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Display question
                document.getElementById('questionStem').textContent = question.stem;
                
                // Display options based on type
                if (question.exam_type === 'mains') {
                    this.displayMainsQuestion(question);
                } else {
                    this.displayMCQQuestion(question);
                }
                
                this.updateMarkReviewButton();
                this.updateNavigationButtons();
                this.updateNavigationGrid();
            }

            displayMCQQuestion(question) {
                const container = document.getElementById('optionsContainer');
                container.innerHTML = '';
                
                question.options.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';
                    
                    const radioId = `option_${option.id}_${question.id}`;
                    const radioName = `question_${question.id}`;
                    
                    optionDiv.innerHTML = `
                        <input type="radio" name="${radioName}" value="${option.id}" id="${radioId}">
                        <label for="${radioId}">${option.id}) ${option.text}</label>
                    `;
                    
                    optionDiv.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const radio = optionDiv.querySelector('input[type="radio"]');
                            radio.checked = true;
                        }
                        this.selectOption(question.id, option.id);
                    });
                    
                    container.appendChild(optionDiv);
                });
                
                // Restore previous answer
                if (this.userAnswers[question.id]) {
                    const selectedRadio = container.querySelector(`input[value="${this.userAnswers[question.id]}"]`);
                    if (selectedRadio) {
                        selectedRadio.checked = true;
                        selectedRadio.closest('.option').classList.add('selected');
                    }
                }
            }

            displayMainsQuestion(question) {
                const container = document.getElementById('optionsContainer');
                const wordLimit = question.mains_details?.word_limit || 250;
                
                container.innerHTML = `
                    <div class="mains-container">
                        <div style="margin-bottom: 1rem; font-weight: 500;">
                            Word Limit: ${wordLimit} words
                        </div>
                        <textarea 
                            class="input-field" 
                            id="mainsAnswer_${question.id}" 
                            placeholder="Write your answer here..."
                            style="min-height: 300px; font-family: inherit;"
                        ></textarea>
                        <div class="word-count">
                            Word count: <span id="wordCount_${question.id}">0</span> / ${wordLimit}
                        </div>
                    </div>
                `;
                
                const textarea = container.querySelector('textarea');
                const wordCountSpan = document.getElementById(`wordCount_${question.id}`);
                
                textarea.addEventListener('input', () => {
                    const text = textarea.value.trim();
                    const wordCount = text === '' ? 0 : text.split(/\s+/).length;
                    wordCountSpan.textContent = wordCount;
                    
                    if (wordCount > wordLimit) {
                        wordCountSpan.style.color = 'var(--error)';
                    } else {
                        wordCountSpan.style.color = 'var(--text-muted)';
                    }
                    
                    this.userAnswers[question.id] = textarea.value;
                    this.updateNavigationGrid();
                });
                
                // Restore previous answer
                if (this.userAnswers[question.id]) {
                    textarea.value = this.userAnswers[question.id];
                    const wordCount = textarea.value.trim().split(/\s+/).length;
                    wordCountSpan.textContent = wordCount;
                }
            }

            selectOption(questionId, optionId) {
                this.userAnswers[questionId] = optionId;
                
                // Update visual selection
                const container = document.getElementById('optionsContainer');
                container.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                
                const selectedOption = container.querySelector(`input[value="${optionId}"]`);
                if (selectedOption) {
                    selectedOption.closest('.option').classList.add('selected');
                }
                
                this.updateNavigationGrid();
            }

            navigateQuestion(direction) {
                const newIndex = this.currentQuestionIndex + direction;
                if (newIndex >= 0 && newIndex < this.currentDataset.questions.length) {
                    this.displayQuestion(newIndex);
                }
            }

            jumpToQuestion(index) {
                if (index >= 0 && index < this.currentDataset.questions.length) {
                    this.displayQuestion(index);
                }
            }

            updateMarkReviewButton() {
                const btn = document.getElementById('markReview');
                const currentQ = this.currentDataset.questions[this.currentQuestionIndex];
                
                if (this.markedQuestions.has(currentQ.id)) {
                    btn.innerHTML = '‚≠ê Unmark Review';
                } else {
                    btn.innerHTML = '‚≠ê Mark for Review';
                }
            }

            toggleMarkReview() {
                const currentQ = this.currentDataset.questions[this.currentQuestionIndex];
                
                if (this.markedQuestions.has(currentQ.id)) {
                    this.markedQuestions.delete(currentQ.id);
                } else {
                    this.markedQuestions.add(currentQ.id);
                }
                
                this.updateMarkReviewButton();
                this.updateNavigationGrid();
            }

            clearResponse() {
                const currentQ = this.currentDataset.questions[this.currentQuestionIndex];
                delete this.userAnswers[currentQ.id];
                
                if (currentQ.exam_type === 'mains') {
                    const textarea = document.getElementById(`mainsAnswer_${currentQ.id}`);
                    const wordCount = document.getElementById(`wordCount_${currentQ.id}`);
                    if (textarea) textarea.value = '';
                    if (wordCount) wordCount.textContent = '0';
                } else {
                    const container = document.getElementById('optionsContainer');
                    container.querySelectorAll('input[type="radio"]').forEach(radio => {
                        radio.checked = false;
                    });
                    container.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                }
                
                this.updateNavigationGrid();
            }

            updateNavigationButtons() {
                document.getElementById('prevQuestion').disabled = this.currentQuestionIndex === 0;
                document.getElementById('nextQuestion').disabled = 
                    this.currentQuestionIndex === this.currentDataset.questions.length - 1;
            }

            updateNavigationGrid() {
                const navButtons = document.querySelectorAll('.nav-btn');
                
                navButtons.forEach((btn, index) => {
                    btn.classList.remove('answered', 'marked', 'current');
                    
                    const question = this.currentDataset.questions[index];
                    
                    if (index === this.currentQuestionIndex) {
                        btn.classList.add('current');
                    } else if (this.userAnswers[question.id]) {
                        btn.classList.add('answered');
                    }
                    
                    if (this.markedQuestions.has(question.id)) {
                        btn.classList.add('marked');
                    }
                });
            }

            submitQuiz(autoSubmit = false) {
                const answered = Object.keys(this.userAnswers).length;
                const total = this.currentDataset.questions.length;
                const unanswered = total - answered;
                
                if (!autoSubmit && unanswered > 0) {
                    if (!confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`)) {
                        return;
                    }
                }
                
                if (!autoSubmit && !confirm('Submit quiz? You cannot change answers after submission.')) {
                    return;
                }
                
                clearInterval(this.timer);
                this.isQuizActive = false;
                
                this.calculateResults();
                this.displayResults();
                this.switchTab('results');
                
                this.showMessage(
                    autoSubmit ? '‚è∞ Time\'s up! Quiz auto-submitted.' : '‚úÖ Quiz submitted successfully!',
                    autoSubmit ? 'warning' : 'success'
                );
            }

            calculateResults() {
                const config = this.currentDataset.quiz.config;
                const marksPerQuestion = config.marks_per_question || 2;
                const negativeMarking = config.negative_marking || { type: 'fraction', value: 0.33 };
                
                let correct = 0;
                let incorrect = 0;
                let skipped = 0;
                let totalScore = 0;
                
                const questionResults = [];
                
                this.currentDataset.questions.forEach(question => {
                    const userAnswer = this.userAnswers[question.id];
                    const isCorrect = question.exam_type === 'mains' || userAnswer === question.answer;
                    
                    let questionScore = 0;
                    let status = 'skipped';
                    
                    if (userAnswer) {
                        if (question.exam_type === 'mains') {
                            questionScore = marksPerQuestion; // Mains answers are marked as correct by default
                            correct++;
                            status = 'attempted';
                        } else if (isCorrect) {
                            questionScore = marksPerQuestion;
                            correct++;
                            status = 'correct';
                        } else {
                            questionScore = -marksPerQuestion * negativeMarking.value;
                            incorrect++;
                            status = 'incorrect';
                        }
                    } else {
                        skipped++;
                    }
                    
                    totalScore += questionScore;
                    
                    questionResults.push({
                        question,
                        userAnswer,
                        isCorrect,
                        status,
                        score: questionScore
                    });
                });
                
                const maxScore = this.currentDataset.questions.length * marksPerQuestion;
                const attempted = correct + incorrect;
                const accuracy = attempted > 0 ? (correct / attempted) * 100 : 0;
                
                this.quizResults = {
                    totalScore,
                    maxScore,
                    correct,
                    incorrect,
                    skipped,
                    attempted,
                    accuracy,
                    timeTaken: this.elapsedTime * 1000,
                    questionResults
                };
                
                this.saveToStorage();
            }

            displayResults() {
                document.getElementById('resultsNotAvailable').classList.add('hidden');
                document.getElementById('resultsInterface').classList.remove('hidden');
                
                const results = this.quizResults;
                
                // Update stats
                document.getElementById('finalScore').textContent = 
                    `${results.totalScore.toFixed(2)} / ${results.maxScore}`;
                document.getElementById('questionsAttempted').textContent = 
                    `${results.attempted} / ${this.currentDataset.questions.length}`;
                document.getElementById('correctAnswers').textContent = results.correct;
                document.getElementById('incorrectAnswers').textContent = results.incorrect;
                document.getElementById('accuracy').textContent = `${results.accuracy.toFixed(1)}%`;
                document.getElementById('timeTaken').textContent = this.formatTime(results.timeTaken);
                
                this.displayQuestionReviews();
            }

            displayQuestionReviews() {
                const container = document.getElementById('questionReviews');
                container.innerHTML = '';
                
                this.quizResults.questionResults.forEach((result, index) => {
                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = `question-review ${result.status}`;
                    
                    const statusIcons = {
                        correct: '‚úÖ',
                        incorrect: '‚ùå',
                        skipped: '‚è≠Ô∏è',
                        attempted: 'üìù'
                    };
                    
                    const statusLabels = {
                        correct: 'Correct',
                        incorrect: 'Incorrect',
                        skipped: 'Skipped',
                        attempted: 'Attempted'
                    };
                    
                    let optionsHTML = '';
                    if (result.question.exam_type !== 'mains' && result.question.options) {
                        optionsHTML = '<div style="margin: 1rem 0;">';
                        result.question.options.forEach(option => {
                            let optionClass = '';
                            if (option.id === result.question.answer) {
                                optionClass = 'correct';
                            } else if (option.id === result.userAnswer && result.userAnswer !== result.question.answer) {
                                optionClass = 'incorrect';
                            }
                            
                            optionsHTML += `
                                <div class="option ${optionClass}" style="cursor: default; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">${option.id})</span>
                                    <label style="cursor: default;">${option.text}</label>
                                </div>
                            `;
                        });
                        optionsHTML += '</div>';
                    }
                    
                    reviewDiv.innerHTML = `
                        <h4>${statusIcons[result.status]} Question ${index + 1} - ${statusLabels[result.status]}</h4>
                        <div style="margin: 1rem 0; font-size: 1.05rem;">${result.question.stem}</div>
                        ${optionsHTML}
                        <div style="margin: 0.75rem 0;">
                            <strong>Your Answer:</strong> 
                            <span style="color: var(--primary);">${result.userAnswer || 'Not answered'}</span>
                        </div>
                        ${result.question.exam_type !== 'mains' ? `
                            <div style="margin: 0.75rem 0;">
                                <strong>Correct Answer:</strong> 
                                <span style="color: var(--success);">${result.question.answer}</span>
                            </div>
                        ` : ''}
                        ${result.question.rationale ? `
                            <div class="rationale">
                                <strong>Explanation:</strong><br>
                                ${result.question.rationale}
                            </div>
                        ` : ''}
                        <div style="margin-top: 1rem; font-weight: 600; font-size: 1.1rem; color: ${result.score >= 0 ? 'var(--success)' : 'var(--error)'};">
                            Score: ${result.score >= 0 ? '+' : ''}${result.score.toFixed(2)} marks
                        </div>
                    `;
                    
                    container.appendChild(reviewDiv);
                });
            }

            async downloadSummaryPDF() {
                if (!this.quizResults) {
                    this.showMessage('No results available to export.', 'error');
                    return;
                }

                if (typeof window.jspdf === 'undefined') {
                    this.showMessage('PDF library not loaded. Please refresh the page.', 'error');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 20;
                    let yPos = margin;

                    // Helper function to add text with word wrap
                    const addText = (text, fontSize = 12, isBold = false) => {
                        doc.setFontSize(fontSize);
                        if (isBold) doc.setFont(undefined, 'bold');
                        else doc.setFont(undefined, 'normal');
                        
                        const lines = doc.splitTextToSize(text, pageWidth - 2 * margin);
                        lines.forEach(line => {
                            if (yPos > pageHeight - margin) {
                                doc.addPage();
                                yPos = margin;
                            }
                            doc.text(line, margin, yPos);
                            yPos += fontSize * 0.5;
                        });
                        yPos += 5;
                    };

                    // Header
                    doc.setFillColor(37, 99, 235);
                    doc.rect(0, 0, pageWidth, 40, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    doc.text('UPSC Quiz Report', pageWidth / 2, 25, { align: 'center' });
                    
                    yPos = 50;
                    doc.setTextColor(0, 0, 0);

                    // Quiz Info
                    addText(`Quiz: ${this.currentDataset.quiz.title || 'UPSC Practice Quiz'}`, 16, true);
                    addText(`Date: ${new Date().toLocaleDateString()}`, 11);
                    yPos += 5;

                    // Results Summary
                    addText('Performance Summary', 16, true);
                    addText(`Final Score: ${this.quizResults.totalScore.toFixed(2)} / ${this.quizResults.maxScore}`, 12);
                    addText(`Questions Attempted: ${this.quizResults.attempted} / ${this.currentDataset.questions.length}`, 12);
                    addText(`Correct Answers: ${this.quizResults.correct}`, 12);
                    addText(`Incorrect Answers: ${this.quizResults.incorrect}`, 12);
                    addText(`Accuracy: ${this.quizResults.accuracy.toFixed(1)}%`, 12);
                    addText(`Time Taken: ${this.formatTime(this.quizResults.timeTaken)}`, 12);
                    yPos += 10;

                    // Question Details
                    addText('Question-wise Breakdown', 16, true);
                    
                    this.quizResults.questionResults.forEach((result, index) => {
                        if (yPos > pageHeight - 60) {
                            doc.addPage();
                            yPos = margin;
                        }
                        
                        const statusLabels = {
                            correct: 'CORRECT',
                            incorrect: 'INCORRECT',
                            skipped: 'SKIPPED',
                            attempted: 'ATTEMPTED'
                        };
                        
                        addText(`Q${index + 1}: ${statusLabels[result.status]}`, 12, true);
                        addText(result.question.stem.substring(0, 150) + (result.question.stem.length > 150 ? '...' : ''), 10);
                        
                        if (result.question.exam_type !== 'mains') {
                            addText(`Your Answer: ${result.userAnswer || 'Not answered'}`, 10);
                            addText(`Correct Answer: ${result.question.answer}`, 10);
                        }
                        
                        addText(`Score: ${result.score >= 0 ? '+' : ''}${result.score.toFixed(2)} marks`, 10, true);
                        yPos += 5;
                    });

                    // Footer
                    const totalPages = doc.internal.pages.length - 1;
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(9);
                        doc.setTextColor(128);
                        doc.text(
                            `Page ${i} of ${totalPages} | Generated by Pragyaan 2.0`,
                            pageWidth / 2,
                            pageHeight - 10,
                            { align: 'center' }
                        );
                    }

                    doc.save(`quiz_report_${Date.now()}.pdf`);
                    this.showMessage('üìÑ PDF report downloaded successfully!', 'success');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    this.showMessage('Failed to generate PDF: ' + error.message, 'error');
                }
            }

            exportResults() {
                if (!this.quizResults) {
                    this.showMessage('No results to export.', 'error');
                    return;
                }
                
                const exportData = {
                    quiz: this.currentDataset.quiz,
                    results: this.quizResults,
                    userAnswers: this.userAnswers,
                    markedQuestions: Array.from(this.markedQuestions),
                    exportDate: new Date().toISOString(),
                    platform: 'Pragyaan 2.0'
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quiz_results_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage('üíæ Results exported successfully!', 'success');
            }

            retakeQuiz() {
                if (confirm('Start a new attempt? This will clear your current results.')) {
                    // Reset quiz state
                    this.userAnswers = {};
                    this.markedQuestions = new Set();
                    this.currentQuestionIndex = 0;
                    this.quizResults = null;
                    this.isQuizActive = false;
                    this.elapsedTime = 0;
                    
                    // Clear timer
                    if (this.timer) {
                        clearInterval(this.timer);
                        this.timer = null;
                    }
                    
                    // Reset UI
                    document.getElementById('resultsInterface').classList.add('hidden');
                    document.getElementById('resultsNotAvailable').classList.remove('hidden');
                    document.getElementById('quizStarted').classList.add('hidden');
                    document.getElementById('startQuiz').classList.remove('hidden');
                    document.getElementById('submitQuiz').classList.add('hidden');
                    document.getElementById('quizInfo').classList.remove('hidden');
                    
                    this.saveToStorage();
                    this.switchTab('quiz');
                    this.showMessage('Ready to retake the quiz!', 'success');
                }
            }

            renderSchemaTemplate() {
                const schema = {
                    "quiz": {
                        "title": "UPSC Prelims Mock Test 2025",
                        "description": "Comprehensive test covering History, Geography, Polity, and Current Affairs",
                        "exam_year": 2025,
                        "config": {
                            "marks_per_question": 2,
                            "negative_marking": {
                                "type": "fraction",
                                "value": 0.33
                            },
                            "time_limit_minutes": 120
                        }
                    },
                    "questions": [
                        {
                            "id": "Q001",
                            "exam_type": "prelims",
                            "question_type": "MCQ",
                            "stem": "Which of the following statements about the Indian Constitution is/are correct?\n1. It is the longest written constitution in the world.\n2. It was adopted on 26 January 1950.\n3. Dr. B.R. Ambedkar is known as the Father of the Constitution.\n\nSelect the correct answer using the code given below:",
                            "options": [
                                {
                                    "id": "A",
                                    "text": "1 and 2 only"
                                },
                                {
                                    "id": "B",
                                    "text": "2 and 3 only"
                                },
                                {
                                    "id": "C",
                                    "text": "1 and 3 only"
                                },
                                {
                                    "id": "D",
                                    "text": "1, 2 and 3"
                                }
                            ],
                            "answer": "C",
                            "rationale": "Statement 1 is correct - The Indian Constitution is indeed the longest written constitution in the world with 395 articles and 8 schedules originally. Statement 2 is incorrect - The Constitution was adopted on 26 November 1949, but came into effect on 26 January 1950. Statement 3 is correct - Dr. B.R. Ambedkar, as Chairman of the Drafting Committee, is widely regarded as the Father of the Indian Constitution.",
                            "difficulty": "Moderate",
                            "estimated_time": 90,
                            "tags": ["Polity", "Constitution", "Fundamentals"],
                            "subject": "Polity",
                            "topic": "Constitutional Framework",
                            "source": "Practice Mock Test"
                        },
                        {
                            "id": "Q002",
                            "exam_type": "mains",
                            "question_type": "Essay",
                            "stem": "Discuss the role of the judiciary in protecting fundamental rights in India. Illustrate your answer with suitable examples from landmark judgments.",
                            "mains_details": {
                                "word_limit": 250,
                                "marks": 15
                            },
                            "rationale": "This is a mains question requiring detailed analysis of judicial activism and landmark cases. Key points should include: Article 32 and 226, PIL, cases like Kesavananda Bharati, Maneka Gandhi, Vishaka, etc.",
                            "difficulty": "Hard",
                            "estimated_time": 300,
                            "tags": ["Polity", "Judiciary", "Fundamental Rights"],
                            "subject": "Polity",
                            "topic": "Judicial Review"
                        }
                    ]
                };
                
                document.getElementById('schemaTemplate').textContent = JSON.stringify(schema, null, 2);
            }

            downloadSchemaTemplate() {
                const schemaText = document.getElementById('schemaTemplate').textContent;
                const blob = new Blob([schemaText], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'upsc_quiz_schema_template.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage('Schema template downloaded!', 'success');
            }

            copySchemaToClipboard() {
                const schemaText = document.getElementById('schemaTemplate').textContent;
                
                navigator.clipboard.writeText(schemaText).then(() => {
                    this.showMessage('Schema copied to clipboard!', 'success');
                }).catch(err => {
                    this.showMessage('Failed to copy: ' + err.message, 'error');
                });
            }

            formatTime(milliseconds) {
                const totalSeconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m ${seconds}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${seconds}s`;
                } else {
                    return `${seconds}s`;
                }
            }

            saveToStorage() {
                try {
                    const data = {
                        dataset: this.currentDataset,
                        answers: this.userAnswers,
                        markedQuestions: Array.from(this.markedQuestions),
                        currentIndex: this.currentQuestionIndex,
                        results: this.quizResults,
                        isQuizActive: this.isQuizActive,
                        elapsedTime: this.elapsedTime,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('pragyaan_quiz_data', JSON.stringify(data));
                } catch (error) {
                    console.error('Failed to save to storage:', error);
                }
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('pragyaan_quiz_data');
                    if (!stored) return;
                    
                    const data = JSON.parse(stored);
                    
                    this.currentDataset = data.dataset;
                    this.userAnswers = data.answers || {};
                    this.markedQuestions = new Set(data.markedQuestions || []);
                    this.currentQuestionIndex = data.currentIndex || 0;
                    this.quizResults = data.results;
                    this.isQuizActive = data.isQuizActive || false;
                    this.elapsedTime = data.elapsedTime || 0;
                    
                    if (this.currentDataset) {
                        this.initializeQuiz();
                        
                        if (this.isQuizActive) {
                            document.getElementById('startQuiz').classList.add('hidden');
                            document.getElementById('submitQuiz').classList.remove('hidden');
                            document.getElementById('quizStarted').classList.remove('hidden');
                            this.displayQuestion(this.currentQuestionIndex);
                            this.startTimer();
                        }
                    }
                    
                    if (this.quizResults) {
                        this.displayResults();
                    }
                } catch (error) {
                    console.error('Failed to load from storage:', error);
                    localStorage.removeItem('pragyaan_quiz_data');
                }
            }

            clearAllData() {
                if (confirm('This will delete all data including quiz progress and results. Continue?')) {
                    localStorage.removeItem('pragyaan_quiz_data');
                    this.showMessage('All data cleared successfully!', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            }

            showMessage(message, type) {
                const container = document.getElementById('validationMessage');
                if (!container) return;
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                
                alertDiv.innerHTML = `
                    <span>${icons[type] || ''}</span>
                    <div>${message}</div>
                `;
                
                container.innerHTML = '';
                container.appendChild(alertDiv);
                
                if (type === 'success') {
                    setTimeout(() => {
                        if (alertDiv.parentNode === container) {
                            container.innerHTML = '';
                        }
                    }, 4000);
                }
            }
        }

        // Initialize platform
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const platform = new UPSCQuizPlatform();
                window.upscQuizPlatform = platform;
                console.log('Pragyaan 2.0 initialized successfully');
            } catch (error) {
                console.error('Failed to initialize platform:', error);
                alert('Failed to initialize quiz platform. Please refresh the page.');
            }
        });
    </script>
</body>
</html>
